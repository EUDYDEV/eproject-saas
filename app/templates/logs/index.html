{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Logs</h1>
  <form method="post" action="{{ url_for('logs.clear_logs') }}" data-confirm="Supprimer tout l historique des logs ?">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-outline-danger">Vider l historique</button>
  </form>
</div>

<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-5">
        <label class="form-label mb-1">Recherche</label>
        <input class="form-control" name="q" value="{{ q }}" placeholder="Type, action, details, utilisateur, email, agence">
      </div>
      <div class="col-md-3">
        <label class="form-label mb-1">Branche</label>
        <select class="form-select" name="branch_id">
          <option value="0">Toutes les branches</option>
          {% for b in branch_filter_options %}
          <option value="{{ b.id }}" {% if branch_filter == b.id %}selected{% endif %}>{{ b.name }} ({{ b.country_code }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label mb-1">Type d événement</label>
        <select class="form-select" name="event_type">
          <option value="">Tous</option>
          {% for e in event_options %}
          <option value="{{ e }}" {% if event_type == e %}selected{% endif %}>{{ e }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-1 d-grid">
        <button class="btn btn-primary" type="submit">OK</button>
      </div>
      <div class="col-md-1 d-grid">
        <a class="btn btn-outline-secondary" href="{{ url_for('logs.logs_index', branch_id=branch_filter if branch_filter else None) }}">Reset</a>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>Date</th>
          <th>Utilisateur</th>
          <th>Agence</th>
          <th>Type</th>
          <th>Action</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else '-' }}</td>
          <td>
            <div class="fw-semibold">{{ r.user.username if r.user else ('#' ~ r.user_id) }}</div>
            <div class="small text-muted">{{ r.user.email if r.user else '-' }}</div>
          </td>
          <td>{{ r.branch.name if r.branch else '-' }}</td>
          <td><span class="badge text-bg-light">{{ r.type_event }}</span></td>
          <td>{{ r.action or '-' }}</td>
          <td class="text-break" style="max-width: 420px;">{{ r.details or '-' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="6" class="text-muted">Aucun log.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if pagination and pagination.pages > 1 %}
<div class="d-flex justify-content-between align-items-center mt-3">
  <div class="small text-muted">Page {{ pagination.page }} / {{ pagination.pages }}</div>
  <div class="btn-group">
    {% if pagination.has_prev %}
    <a class="btn btn-outline-secondary" href="{{ url_for('logs.logs_index', page=pagination.prev_num, q=q, event_type=event_type, branch_id=branch_filter if branch_filter else None) }}">Precedent</a>
    {% else %}
    <button class="btn btn-outline-secondary" disabled>Precedent</button>
    {% endif %}

    {% if pagination.has_next %}
    <a class="btn btn-outline-secondary" href="{{ url_for('logs.logs_index', page=pagination.next_num, q=q, event_type=event_type, branch_id=branch_filter if branch_filter else None) }}">Suivant</a>
    {% else %}
    <button class="btn btn-outline-secondary" disabled>Suivant</button>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}

