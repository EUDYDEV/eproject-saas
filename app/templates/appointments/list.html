{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Rendez-vous (Événements)</h1>
  <a class="btn btn-primary" href="{{ url_for('appointments.create_event', branch_id=branch_filter if branch_filter else None) }}">Nouvel événement</a>
</div>

<form class="row g-2 mb-3" method="get">
  <div class="col-12 col-md-6">
    <select class="form-select" name="branch_id">
      <option value="0">Toutes les branches</option>
      {% for b in branch_filter_options %}
      <option value="{{ b.id }}" {% if branch_filter == b.id %}selected{% endif %}>{{ b.name }} ({{ b.country_code }})</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12 col-md-3 d-grid">
    <button class="btn btn-outline-primary" type="submit">Filtrer</button>
  </div>
</form>

<div class="card mb-3">
  <div class="card-header">Événements</div>
  <div class="table-responsive">
    <table class="table table-striped mb-0">
      <thead><tr><th>Titre</th><th>Slug</th><th>Periode</th><th>Lieu</th><th>Max/jour</th><th>Actif</th><th></th></tr></thead>
      <tbody>
      {% for e in events %}
      <tr>
        <td>{{ e.title }}</td>
        <td><code>{{ e.slug }}</code></td>
        <td>{{ e.start_date }} - {{ e.end_date }}</td>
        <td>{{ e.location or '-' }}</td>
        <td>{{ e.max_per_day }}</td>
        <td>{{ 'Oui' if e.is_active else 'Non' }}</td>
        <td class="d-flex gap-1">
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('appointments.view_event', event_id=e.id, branch_id=branch_filter if branch_filter else None) }}">Ouvrir</a>
          {% if current_user.role in ['FOUNDER', 'ADMIN_BRANCH', 'IT', 'INFORMATICIEN'] %}
          <form method="post" action="{{ url_for('appointments.delete_event', event_id=e.id) }}" data-confirm="Supprimer cet événement et tous ses RDV ?">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-sm btn-outline-danger" type="submit">Supprimer</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="7" class="text-muted">Aucun événement.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <div class="card-header">Bookings a venir</div>
  <div class="table-responsive">
    <table class="table table-sm mb-0">
      <thead><tr><th>Nom</th><th>Email</th><th>Tel</th><th>Date/Heure</th><th>Status</th><th></th></tr></thead>
      <tbody>
      {% for b in upcoming_bookings %}
      <tr>
        <td>{{ b.name }}</td>
        <td>{{ b.email }}</td>
        <td>{{ b.phone or '-' }}</td>
        <td>{{ b.event_slot.start_datetime.strftime('%Y-%m-%d %H:%M') if b.event_slot else '-' }}</td>
        <td>{{ b.status }}</td>
        <td>
          <form method="post" action="{{ url_for('appointments.delete_booking', booking_id=b.id) }}" data-confirm="Supprimer ce RDV ?">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="next" value="{{ request.url }}">
            <button class="btn btn-sm btn-outline-danger" type="submit">Supprimer</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6" class="text-muted">Aucun booking a venir.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="card mt-3">
  <div class="card-header">Confirmations recentes (depuis liens email/public)</div>
  <div class="table-responsive">
    <table class="table table-sm mb-0">
      <thead><tr><th>Date confirmation</th><th>Nom</th><th>Email</th><th>Tel</th><th>Événement</th><th>Creneau</th><th>Source</th><th>Status</th><th></th></tr></thead>
      <tbody>
      {% for b in recent_confirmed_bookings %}
      <tr>
        <td>{{ b.created_at.strftime('%Y-%m-%d %H:%M') if b.created_at else '-' }}</td>
        <td>{{ b.name }}</td>
        <td>{{ b.email }}</td>
        <td>{{ b.phone or '-' }}</td>
        <td>{{ b.event_slot.event.title if b.event_slot and b.event_slot.event else '-' }}</td>
        <td>{{ b.event_slot.start_datetime.strftime('%Y-%m-%d %H:%M') if b.event_slot else '-' }}</td>
        <td>
          {% if b.invite_token_id %}
          <span class="badge text-bg-success">Email token</span>
          {% else %}
          <span class="badge text-bg-secondary">Public</span>
          {% endif %}
        </td>
        <td>{{ b.status }}</td>
        <td>
          <form method="post" action="{{ url_for('appointments.delete_booking', booking_id=b.id) }}" data-confirm="Supprimer ce RDV ?">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="next" value="{{ request.url }}">
            <button class="btn btn-sm btn-outline-danger" type="submit">Supprimer</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="9" class="text-muted">Aucune confirmation recente.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}




