{% extends "base.html" %}
{% block content %}
<style>
  .sub-wrap {
    min-height: 82vh;
    background:
      radial-gradient(1100px 450px at 85% -20%, rgba(59,130,246,.28), transparent 60%),
      radial-gradient(1000px 420px at -10% 8%, rgba(14,165,233,.2), transparent 58%),
      linear-gradient(180deg, #0f172a 0%, #111827 50%, #0b1224 100%);
    border-radius: 18px;
    padding: 1.25rem;
    color: #f8fafc;
  }
  .sub-card {
    background: rgba(15,23,42,.72);
    border: 1px solid rgba(148,163,184,.28);
    border-radius: 14px;
    backdrop-filter: blur(6px);
  }
  .plan-card {
    border: 1px solid rgba(148,163,184,.35);
    border-radius: 14px;
    background: rgba(30,41,59,.5);
  }
</style>

<div class="sub-wrap">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Activation abonnement agence</h1>
    <a class="btn btn-outline-light btn-sm" href="{{ url_for('auth.logout') }}">Quitter</a>
  </div>

  {% if missing_branch %}
  <div class="alert alert-danger">
    Compte propri√©taire non rattache a une agence. Contacte IT pour liaison branche.
  </div>
  {% endif %}

  <div class="sub-card p-3 mb-3">
    {% if subscription %}
    <div class="row g-2">
      <div class="col-md-3"><div class="small text-secondary">Statut</div><div class="fw-bold">{{ subscription.status|upper }}</div></div>
      <div class="col-md-3"><div class="small text-secondary">Plan</div><div class="fw-bold">{{ subscription.plan_code|upper }}</div></div>
      <div class="col-md-3"><div class="small text-secondary">Montant</div><div class="fw-bold">{{ '%.0f'|format(subscription.amount or 0) }} {{ subscription.currency }}</div></div>
      <div class="col-md-3"><div class="small text-secondary">Fin de validite</div><div class="fw-bold">{{ subscription.ends_at.strftime('%d/%m/%Y') if subscription.ends_at else '-' }}</div></div>
    </div>
    {% else %}
    <div class="text-warning">Abonnement indisponible tant que la branche n'est pas rattachee.</div>
    {% endif %}
  </div>

  <div class="row g-3 mb-3">
    {% for p in plans %}
    <div class="col-md-4">
      <div class="plan-card p-3 h-100">
        <div class="text-info small text-uppercase fw-semibold">{{ p.name }}</div>
        <div class="fs-3 fw-bold">{{ '%.0f'|format(p.price or 0) }} <span class="fs-6 fw-normal">{{ p.currency }}/mois</span></div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="sub-card p-3 mb-3">
    <h2 class="h6 mb-3">Choisir un plan</h2>
    {% if not subscription %}
    <div class="alert alert-warning mb-0">Action indisponible: liaison branche requise.</div>
    {% else %}
    <form method="post" class="row g-2 align-items-end">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="action" value="change_plan">
      <div class="col-md-6">
        <label class="form-label">Plan</label>
        <select class="form-select" name="plan_code" id="plan_code_select">
          {% for p in plans %}
          <option value="{{ p.code }}" {% if subscription.plan_code == p.code %}selected{% endif %}>{{ p.name }} - {{ '%.0f'|format(p.price or 0) }} {{ p.currency }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <button class="btn btn-outline-light" type="submit">Mettre a jour le plan</button>
      </div>
    </form>
    {% endif %}
  </div>

  <div class="sub-card p-3">
    <h2 class="h6 mb-3">Paiement</h2>
    {% if not subscription %}
    <div class="alert alert-warning mb-0">Action indisponible: liaison branche requise.</div>
    {% else %}
    {% if current_plan_payment_link %}
    <a class="btn btn-primary mb-3" id="pay_now_button" href="{{ current_plan_payment_link }}" target="_blank" rel="noopener">Payer maintenant</a>
    {% else %}
    <div class="alert alert-warning">Aucun lien de paiement configure par IT pour le moment.</div>
    {% endif %}
    <form method="post" class="row g-2 align-items-end">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="action" value="mark_payment_sent">
      <div class="col-md-8">
        <label class="form-label">Reference paiement (optionnel)</label>
        <input class="form-control" name="payment_reference" placeholder="Ex: Wave-123456">
      </div>
      <div class="col-md-4">
        <button class="btn btn-success w-100" type="submit">J'ai deja paye</button>
      </div>
    </form>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const select = document.getElementById("plan_code_select");
    const payBtn = document.getElementById("pay_now_button");
    if (!select || !payBtn) return;
    const links = {{ plan_payment_links|tojson }};
    const update = function () {
      const plan = (select.value || "").toLowerCase();
      const url = links[plan] || "";
      if (url) {
        payBtn.setAttribute("href", url);
        payBtn.classList.remove("disabled");
      } else {
        payBtn.setAttribute("href", "#");
        payBtn.classList.add("disabled");
      }
    };
    select.addEventListener("change", update);
    update();
  })();
</script>
{% endblock %}

