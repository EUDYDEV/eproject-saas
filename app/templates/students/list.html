{% extends "base.html" %}
{% block content %}
<div class="alert alert-warning py-2">
  VERSION EXPORT PREMIUM ACTIVE
</div>
<div class="d-flex justify-content-between mb-3 align-items-center">
  <h1 class="h4 mb-0">Étudiants</h1>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-success" href="{{ url_for('students.export_students_csv') }}">Exporter Excel</a>
    <a class="btn btn-primary" href="{{ url_for('students.create_student') }}">Nouveau</a>
  </div>
</div>
{% if unassigned_count and unassigned_count > 0 %}
<div class="alert alert-warning py-2">
  Étudiants sans branche detectes: <strong>{{ unassigned_count }}</strong>. Les nouvelles creations/imports sont maintenant affectes automatiquement a la branche du compte connecte.
</div>
{% endif %}
<form method="get" class="mb-3">
  <div class="row g-2">
    <div class="col-md-5"><input class="form-control" name="q" value="{{ q }}" placeholder="Recherche"></div>
    <div class="col-md-4">
      <select class="form-select" name="branch_id">
        <option value="0">Toutes les branches (scope autorise)</option>
        {% for b in branch_filter_options %}
        <option value="{{ b.id }}" {% if branch_filter == b.id %}selected{% endif %}>{{ b.name }} ({{ b.country_code }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" value="1" id="abroadOnly" name="abroad" {% if abroad_only %}checked{% endif %}>
        <label class="form-check-label" for="abroadOnly">A l'étranger</label>
      </div>
    </div>
    <div class="col-md-1 d-grid"><button class="btn btn-outline-secondary" type="submit">OK</button></div>
  </div>
</form>
<div class="table-responsive"><table class="table table-striped align-middle"><thead><tr><th>Matricule</th><th>Nom</th><th>Filiere</th><th>Niveau</th><th>Statut</th><th></th></tr></thead><tbody>
{% for s in students %}
<tr>
  <td>{{ s.matricule }}</td>
  <td>{{ s.nom }} {{ s.prenoms }}</td>
  <td>{{ s.filiere }}</td>
  <td>{{ s.niveau }}</td>
  <td>{{ s.statut }}</td>
  <td class="d-flex gap-1">
    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('students.view_student', student_id=s.id) }}">Voir</a>
    {% if current_user.role in ['FOUNDER', 'ADMIN_BRANCH', 'ADMIN'] %}
    <form method="post" action="{{ url_for('students.delete_student', student_id=s.id) }}" data-confirm="Supprimer cet étudiant ? Cette action est irreversible.">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button class="btn btn-sm btn-outline-danger" type="submit">Supprimer</button>
    </form>
    {% endif %}
  </td>
</tr>
{% endfor %}
</tbody></table></div>

{% if pagination and pagination.pages > 1 %}
<div class="d-flex justify-content-between align-items-center mt-3">
  <div class="small text-muted">
    Page {{ pagination.page }} / {{ pagination.pages }} ({{ pagination.total }} étudiants)
  </div>
  <div class="btn-group">
    {% if pagination.has_prev %}
    <a class="btn btn-outline-secondary" href="{{ url_for('students.list_students', page=pagination.prev_num, q=q, branch_id=branch_filter, abroad='1' if abroad_only else None) }}">Precedent</a>
    {% else %}
    <button class="btn btn-outline-secondary" disabled>Precedent</button>
    {% endif %}

    {% if pagination.has_next %}
    <a class="btn btn-outline-secondary" href="{{ url_for('students.list_students', page=pagination.next_num, q=q, branch_id=branch_filter, abroad='1' if abroad_only else None) }}">Suivant</a>
    {% else %}
    <button class="btn btn-outline-secondary" disabled>Suivant</button>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}

